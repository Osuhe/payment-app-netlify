<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Enviar Dinero a Cuba ‚Äì Prototipo</title>
<style>
  :root{
    --bg:#0f172a; --card:#0b1220; --border:#1f2937; --muted:#94a3b8; --ink:#e5e7eb;
    --accent:#4f46e5; --ok:#16a34a; --input:#0a0f1a; --input-border:#334155; --input-focus:#4f46e5;
  }
  *{ box-sizing:border-box }
  html,body{ margin:0; padding:0; width: 100%; min-height: 100%; background:var(--bg); color:var(--ink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .wrap{ width: 100%; max-width: 1000px; margin: 0 auto; padding: 16px; box-sizing: border-box; }
  .toolbar{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
  .badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px;
    background:#0b1220; border:1px solid var(--border); color:var(--muted); }
  .muted{ color:var(--muted); font-size:13px; }
  .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
  @media (min-width: 900px){ .grid{ grid-template-columns: 1.2fr .8fr; } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  h1{ margin:0 0 12px; font-size:28px; }
  h2{ margin:16px 0 10px; font-size:20px; color:#cbd5e1; }
  label{ display:block; font-size:14px; margin:8px 0 6px; color:#cbd5e1; }
  input, select{
    width:100%; height:46px; padding:10px 12px; border-radius:12px;
    border:1px solid var(--input-border); background:var(--input); color:var(--ink); outline:none;
    font-size: 16px;
  }
  input:focus, select:focus{ border-color:var(--input-focus); box-shadow: 0 0 0 3px rgba(79,70,229,.20); }
  .row{ display:grid; grid-template-columns:1fr; gap:14px; }
  @media (min-width: 680px){ .row.two{ grid-template-columns:1fr 1fr; } }

  .hr{ height:1px; background:var(--border); margin:18px 0; }
  .kvs{ font-size:14px; }
  .kvs div{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed var(--border); }
  .kvs div:last-child{ border-bottom:none; }
  .ok{ color:var(--ok); }
  .flex{ display:flex; align-items:center; gap:8px; }
  .checkbox{ width:auto; }

  /* Estilos para el campo de tarjeta */
  .card-field {
    position: relative;
    margin-bottom: 8px;
    width: 320px;
    max-width: 100%;
  }
  
  .card-field input {
    width: 100%;
    padding: 12px 15px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    letter-spacing: 0.3em;
    font-size: 16px;
    background: var(--input);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    color: transparent; /* Hacemos el texto transparente */
    caret-color: var(--ink); /* Color del cursor */
  }
  
  .card-mask {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    padding: 0 15px;
    pointer-events: none;
    color: white;
    font-size: 16px;
    letter-spacing: 0.3em;
    white-space: pre;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <span class="badge">Prototipo</span>
    <span class="muted">Formulario con c√°lculo autom√°tico y validaciones.</span>
  </div>

  <div class="grid">
    <!-- IZQUIERDA -->
    <div class="card">
      <h1>Enviar Dinero a Cuba</h1>

      <form id="form">
        <h2>Datos del remitente</h2>
        <div class="row two">
          <div>
            <label>Tu nombre completo *</label>
            <input name="remitente_nombre" required />
          </div>
          <div>
            <label>WhatsApp o Tel√©fono *</label>
            <input name="remitente_tel" type="tel" inputmode="numeric" pattern="[0-9]*" required />
          </div>
        </div>
        <div class="row two">
          <div>
            <label>Correo electr√≥nico</label>
            <input name="remitente_email" />
          </div>
          <div>
            <label>Documento (opcional)</label>
            <input name="remitente_doc" placeholder="DNI/ID (opcional)" />
          </div>
        </div>

        <h2>Beneficiario en Cuba</h2>
        <div class="row two">
          <div>
            <label>Nombre del beneficiario *</label>
            <input name="benef_nombre" required />
          </div>
          <div>
            <label>Ciudad / Provincia *</label>
            <input name="benef_ciudad" required />
          </div>
        </div>

        <div class="row two">
          <div>
            <label>Moneda de entrega *</label>
            <select name="entrega" id="entrega" required>
              <option value="">Selecciona‚Ä¶</option>
              <option value="CUP">CUP</option>
              <option value="MLC">MLC</option>
              <option value="CLASICA">Clasica</option>
            </select>
          </div>
          <div><!-- espacio sim√©trico --></div>
        </div>

        <!-- Campo de n√∫mero de tarjeta -->
        <div class="row">
          <div class="card-field">
            <label>N√∫mero de tarjeta *</label>
            <div class="card-field">
              <input id="tarjeta_numero" name="tarjeta_numero" type="tel" inputmode="numeric" pattern="[0-9 ]*" maxlength="19" required />
              <div class="card-mask" id="cardMask">____ ____ ____ ____</div>
            </div>
            <div class="muted" style="margin-top:6px;">Ingresa hasta 16 d√≠gitos. Los "_" ir√°n desapareciendo.</div>
          </div>
        </div>

        <h2>Monto</h2>
        <div class="row two">
          <div>
            <label>Monto a enviar en USD *</label>
            <input type="number" min="1" step="1" name="monto_usd" id="monto_usd" required />
            <div class="muted">M√≠nimo US$1 ‚Äì solo n√∫meros enteros</div>
          </div>
          <div>
            <label>Monto a depositar en tarjeta</label>
            <input name="monto_tarjeta" id="monto_tarjeta" readonly />
          </div>
        </div>

        <div class="row two">
          <div>
            <label>Notas (opcional)</label>
            <input name="notas" placeholder="Referencia, horario, etc." />
          </div>
          <div>
            <label>N√∫mero de orden (auto)</label>
            <input name="orden_id" id="orden_id" readonly />
          </div>
        </div>

        <div class="hr"></div>
        <label class="flex">
          <input class="checkbox" type="checkbox" id="acepto" required />
          <span>Acepto las pol√≠ticas de servicio y reembolsos</span>
        </label>
        <div class="hr"></div>

        <div class="kvs" id="resumen"></div>
      </form>

      <!-- Bot√≥n de PayPal al final -->
      <div class="hr"></div>
      <h2>üí≥ Pagar con PayPal</h2>
      <div id="paypal-button-container"></div>
    </div>

    <!-- DERECHA -->
    <div class="card">
      <h2>Pol√≠ticas y seguridad</h2>
      <ul class="muted" style="line-height:1.6;">
        <li>Reembolsos dentro de 24 horas si no se ha entregado al beneficiario.</li>
        <li>Verificaci√≥n por WhatsApp/Email antes de liberar fondos.</li>
        <li>Pago por env√≠o calculado autom√°ticamente seg√∫n el monto.</li>
      </ul>
      <div class="hr"></div>
      <h2>Tasas de conversi√≥n escalonadas</h2>
      <div class="muted" style="line-height:1.5;">
        <strong>CUP:</strong><br>
        ‚Ä¢ Hasta $99: 410 CUP<br>
        ‚Ä¢ $100-$499: 415 CUP<br>
        ‚Ä¢ $500-$999: 418 CUP<br>
        ‚Ä¢ $1,000-$1,999: 422 CUP<br>
        ‚Ä¢ $2,000+: 425 CUP<br><br>
        <strong>MLC:</strong><br>
        ‚Ä¢ Hasta $99: 2.00 MLC<br>
        ‚Ä¢ $100-$499: 2.05 MLC<br>
        ‚Ä¢ $500-$999: 2.08 MLC<br>
        ‚Ä¢ $1,000-$1,999: 2.12 MLC<br>
        ‚Ä¢ $2,000+: 2.16 MLC<br><br>
        <strong>Clasica:</strong><br>
        ‚Ä¢ Todos los montos: 1.00 USD
      </div>
    </div>
  </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id=ASQfwQYT9PH-THXDUkeq1FCD9l8tBGqo3J69N5HZ-FhfJpnVpORzWuo07n3i8LxMdVasrCCep_D-f-1q&currency=USD"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
  const $ = (q) => document.querySelector(q);
  const form = $('#form');
  const resumen = $('#resumen');
  const ordenInput = $('#orden_id');
  const montoTarjetaInput = $('#monto_tarjeta');
  const montoUsdInput = $('#monto_usd');
  const monedaSelect = $('#entrega');
  const tarjetaInput = document.getElementById('tarjeta_numero');
  const cardMask = document.getElementById('cardMask');
  const telefonoInput = document.querySelector('input[name="remitente_tel"]');

  // Tasas de conversi√≥n escalonadas
  function obtenerTasaConversion(monto, moneda) {
    if (moneda === 'CUP') {
      if (monto <= 99) return 410;
      if (monto <= 499) return 415;
      if (monto <= 999) return 418;
      if (monto <= 1999) return 422;
      return 425;
    } else if (moneda === 'MLC') {
      if (monto <= 99) return 2.00;
      if (monto <= 499) return 2.05;
      if (monto <= 999) return 2.08;
      if (monto <= 1999) return 2.12;
      return 2.16;
    } else if (moneda === 'CLASICA') {
      return 1.00;
    }
    return 1;
  }

  function genOrderId(){
    const r = Math.random().toString(36).slice(2,6).toUpperCase();
    return 'ORD-' + Date.now() + '-' + r;
  }

  function updateCardMask() {
    const value = tarjetaInput.value.replace(/\s/g, '');
    let mask = '';
    
    for (let i = 0; i < 16; i++) {
      if (i > 0 && i % 4 === 0) {
        mask += ' ';
      }
      
      if (i < value.length) {
        mask += value[i];
      } else {
        mask += '_';
      }
    }
    
    cardMask.textContent = mask;
    renderResumen();
  }

  function calcularMontoTarjeta(){
    const monto = Number(montoUsdInput.value || 0);
    const moneda = monedaSelect.value;
    const tasa = obtenerTasaConversion(monto, moneda);
    const montoTarjeta = monto && moneda ? (monto * tasa) : 0;
    montoTarjetaInput.value = (monto && moneda) ? montoTarjeta.toFixed(2) : '';
    return { monto, tasa, montoTarjeta, moneda };
  }

  // Funci√≥n para calcular pago por env√≠o escalonado
  function calcularPagoPorEnvio(monto) {
    if (monto >= 100) return monto * 0.08; // 8%
    if (monto >= 50) return monto * 0.10;  // 10%
    if (monto >= 20) return monto * 0.11;  // 11%
    return monto * 0.11; // 11% para montos menores a $20
  }

  function renderResumen(){
    const fd = new FormData(form);
    const { monto, moneda, tasa } = calcularMontoTarjeta();
    const tarifa = +calcularPagoPorEnvio(monto).toFixed(2);
    const total = +(monto + tarifa).toFixed(2);
    
    let numTarjetaDisplay = '';
    const numTarjeta = (tarjetaInput.value || '').replace(/\D/g,'');
    if (numTarjeta.length > 0) {
      const formatted = numTarjeta.replace(/(.{4})/g, '$1 ').trim();
      numTarjetaDisplay = `<div><strong>N√∫mero de tarjeta</strong><span>${formatted}</span></div>`;
    } else {
      numTarjetaDisplay = `<div><strong>N√∫mero de tarjeta</strong><span>-</span></div>`;
    }

    resumen.innerHTML = `
      <div><strong>Remitente</strong><span>${fd.get('remitente_nombre') || '-'}</span></div>
      <div><strong>Beneficiario</strong><span>${fd.get('benef_nombre') || '-'}</span></div>
      <div><strong>Ciudad</strong><span>${fd.get('benef_ciudad') || '-'}</span></div>
      <div><strong>Moneda</strong><span>${moneda || '-'}</span></div>
      <div><strong>Tasa aplicada</strong><span>${tasa ? tasa + ' ' + moneda + '/USD' : '-'}</span></div>
      ${numTarjetaDisplay}
      <div><strong>Monto (USD)</strong><span>$${monto ? monto.toFixed(0) : '0'}</span></div>
      <div><strong>Pago por env√≠o</strong><span>$${monto ? tarifa.toFixed(2) : '0.00'}</span></div>
      <div><strong>Total a cobrar</strong><span>$${monto ? total.toFixed(2) : '0.00'}</span></div>
      <div><strong>Monto a depositar en tarjeta</strong><span>${montoTarjetaInput.value || '-'}</span></div>
    `;
  }

  function validate(){
    const remitenteNombre = document.querySelector('input[name="remitente_nombre"]').value.trim();
    const remitenteTel = document.querySelector('input[name="remitente_tel"]').value.trim();
    const benefNombre = document.querySelector('input[name="benef_nombre"]').value.trim();
    const benefCiudad = document.querySelector('input[name="benef_ciudad"]').value.trim();
    const entrega = document.querySelector('select[name="entrega"]').value;
    const acepto = document.querySelector('#acepto').checked;
    
    if (!remitenteNombre) return { ok:false, msg:'Ingresa tu nombre completo.' };
    if (!remitenteTel) return { ok:false, msg:'Ingresa tu WhatsApp o tel√©fono.' };
    if (!benefNombre) return { ok:false, msg:'Ingresa el nombre del beneficiario.' };
    if (!benefCiudad) return { ok:false, msg:'Ingresa la ciudad del beneficiario.' };
    if (!entrega) return { ok:false, msg:'Selecciona la moneda de entrega.' };
    if (!acepto) return { ok:false, msg:'Debes aceptar las pol√≠ticas de servicio.' };
    
    const numTarjeta = tarjetaInput.value.replace(/\D/g,'');
    if (numTarjeta.length < 16) return { ok:false, msg:'Ingresa un n√∫mero de tarjeta v√°lido (16 d√≠gitos).' };
    
    const monto = Number(montoUsdInput.value || 0);
    if (monto < 1) return { ok:false, msg:'El monto m√≠nimo es US$1.' };
    if (!Number.isInteger(monto)) return { ok:false, msg:'El monto debe ser un n√∫mero entero.' };
    
    return { ok:true };
  }

  async function enviarDatosEmail(paypalDetails) {
    try {
      const fd = new FormData(form);
      const { monto, moneda } = calcularMontoTarjeta();
      const tarifa = +calcularPagoPorEnvio(monto).toFixed(2);
      const total = +(monto + tarifa).toFixed(2);
      
      const datosEmail = {
        remitente_nombre: fd.get('remitente_nombre'),
        remitente_tel: fd.get('remitente_tel'),
        remitente_email: fd.get('remitente_email'),
        benef_nombre: fd.get('benef_nombre'),
        benef_ciudad: fd.get('benef_ciudad'),
        entrega: fd.get('entrega'),
        tarjeta_numero: fd.get('tarjeta_numero'),
        monto_usd: monto,
        orden_id: fd.get('orden_id'),
        monto_total: total,
        tarifa: tarifa,
        paypal_order_id: paypalDetails.id,
        paypal_status: paypalDetails.status
      };
      
      const response = await fetch('/.netlify/functions/send-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosEmail)
      });
      
      if (response.ok) {
        console.log('Email enviado correctamente');
      } else {
        console.error('Error enviando email:', response.statusText);
      }
    } catch (error) {
      console.error('Error enviando email:', error);
    }
  }


  // Restringir el campo de tel√©fono a solo n√∫meros
  telefonoInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '');
  });

  telefonoInput.addEventListener('paste', (e) => {
    e.preventDefault();
    const paste = (e.clipboardData || window.clipboardData).getData('text');
    const numbersOnly = paste.replace(/\D/g, '');
    e.target.value = numbersOnly;
  });

  // Eventos de c√°lculo/maquetado
  form.addEventListener('input', () => { calcularMontoTarjeta(); renderResumen(); });
  monedaSelect.addEventListener('change', () => { calcularMontoTarjeta(); renderResumen(); });

  // Manejar el evento de entrada en el campo de tarjeta
  tarjetaInput.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '');
    value = value.substring(0, 16);
    
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
      if (i > 0 && i % 4 === 0) {
        formatted += ' ';
      }
      formatted += value[i];
    }
    
    e.target.value = formatted;
    updateCardMask();
    
    const len = e.target.value.length;
    e.target.setSelectionRange(len, len);
  });
  
  tarjetaInput.addEventListener('click', (e) => {
    const len = e.target.value.length;
    e.target.setSelectionRange(len, len);
  });


  // Funci√≥n para inicializar PayPal
  function initPayPal() {
    const container = document.getElementById('paypal-button-container');
    
    function calcularTotal() {
      const monto = Number(montoUsdInput.value || 0);
      const tarifa = calcularPagoPorEnvio(monto);
      return (monto + tarifa).toFixed(2);
    }
    
    const paypalDiv = document.createElement('div');
      paypalDiv.id = 'paypal-button-div';
      paypalDiv.style.marginBottom = '10px';
      container.appendChild(paypalDiv);
      
      const cardDiv = document.createElement('div');
      cardDiv.id = 'card-button-div';
      container.appendChild(cardDiv);
      
      paypal.Buttons({
        style: {
          layout: 'vertical',
            }
          }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function(details) {
          enviarDatosEmail(details);
          alert('¬°Pago completado exitosamente!');
          
          const okBox = document.getElementById('okBox');
          if (okBox) {
            okBox.style.display = 'block';
            okBox.innerHTML = '<p class="ok"><strong>‚úî Pago procesado exitosamente.</strong> Recibir√°s confirmaci√≥n por email.</p>';
          }
        }).catch(function(error) {
          console.error('Error al capturar pago PayPal:', error);
          alert('Error al procesar el pago. Intenta nuevamente.');
        });
      },
      onError: function(err) {
        console.error('Error en PayPal:', err);
      },
      onCancel: function(data) {
        alert('Pago cancelado.');
      }
    }).render('#paypal-button-container');
  }

  // Inicializar PayPal cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    if (window.paypal) {
      initPayPal();
    } else {
      setTimeout(() => {
        if (window.paypal) {
          initPayPal();
        }
      }, 1000);
    }
  });

  // Inicializar
  ordenInput.value = genOrderId();
  updateCardMask();
  calcularMontoTarjeta();
  renderResumen();
</script>
</body>
</html>
