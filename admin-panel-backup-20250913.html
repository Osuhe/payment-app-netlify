<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel de Administraci√≥n - Env√≠os a Cuba</title>
<style>
  :root {
    --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    --card: rgba(15, 23, 42, 0.9);
    --border: #334155;
    --muted: #94a3b8;
    --ink: #f1f5f9;
    --accent: #3b82f6;
    --success: #10b981;
    --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }
  
  * { box-sizing: border-box; }
  
  html, body {
    margin: 0; padding: 0; width: 100%; min-height: 100vh;
    background: var(--bg);
    color: var(--ink);
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
  }
  
  .wrap {
    width: 100%; max-width: 1400px; margin: 0 auto; padding: 24px;
  }
  
  .card {
    background: var(--card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
  }
  
  h1 {
    margin: 0 0 32px;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-align: center;
  }
  
  h2 {
    margin: 0 0 24px;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--ink);
  }
  
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }
  
  .stat-card {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    border: 1px solid var(--border);
    padding: 24px;
    border-radius: 16px;
    text-align: center;
  }
  
  .stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }
  
  .stat-label {
    font-size: 14px;
    color: var(--muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .transaction-item {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }
  
  .loading, .no-data, .error {
    padding: 20px;
    text-align: center;
    border-radius: 8px;
    margin: 10px 0;
  }
  
  .loading {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
  }
  
  .no-data {
    background: rgba(156, 163, 175, 0.1);
    color: #9ca3af;
  }
  
  .error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }
  
  .transaction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .transaction-id {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--accent);
  }
  
  .transaction-date {
    font-size: 0.875rem;
    color: var(--muted);
  }
  
  .transaction-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    font-size: 14px;
  }
  
  .transaction-field {
    display: flex;
    flex-direction: column;
  }
  
  .field-label {
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 4px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .field-value {
    color: var(--ink);
    font-weight: 500;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  
  .empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 12px;
    color: var(--ink);
  }
  
  .document-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    padding: 8px 16px;
    border: 1px solid var(--accent);
    border-radius: 8px;
  }
  
  .document-link:hover {
    background: var(--accent);
    color: white;
  }
  
  @media (max-width: 768px) {
    .wrap { padding: 16px; }
    .card { padding: 20px; }
    h1 { font-size: 2rem; }
    .transaction-grid { grid-template-columns: 1fr; }
    .stats { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h1>üíº Panel de Administraci√≥n</h1>
    
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalTransactions">0</div>
        <div class="stat-label">Total Transacciones</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalAmount">$0</div>
        <div class="stat-label">Monto Total Procesado</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalFees">$0</div>
        <div class="stat-label">Tarifas Cobradas</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgTransaction">$0</div>
        <div class="stat-label">Promedio por Env√≠o</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>üìã Transacciones Recientes</h2>
    <div id="transactionsList">
      <div class="empty-state">
        <h3>üí≥ No hay transacciones</h3>
        <p>No se han registrado env√≠os de dinero a√∫n.</p>
        <p>Las transacciones aparecer√°n aqu√≠ autom√°ticamente cuando los usuarios completen un pago.</p>
      </div>
    </div>
  </div>

  <div class="card" id="documentsSection" style="display: none;">
    <h2>üìÑ Documentos de Identidad</h2>
    <div id="documentsList">
      <div class="empty-state">
        <h3>üìÑ No hay documentos</h3>
        <p>Los documentos de identidad aparecer√°n aqu√≠ cuando los usuarios los suban.</p>
      </div>
    </div>
  </div>
</div>

<script>
// Verificar autenticaci√≥n al cargar la p√°gina
let adminToken = null;

function verificarAutenticacion() {
  adminToken = localStorage.getItem('adminToken');
  
  if (!adminToken) {
    const token = prompt('üîê Acceso restringido\n\nIngresa el token de administrador:');
    if (!token || token !== 'admin-secure-token-2024') {
      alert('‚ùå Token incorrecto. Acceso denegado.');
      window.location.href = '/';
      return false;
    }
    localStorage.setItem('adminToken', token);
    adminToken = token;
  }
  return true;
}

// Verificar autenticaci√≥n al cargar
if (!verificarAutenticacion()) {
  throw new Error('Acceso no autorizado');
}

// Cargar datos autom√°ticamente
async function cargarDatos() {
  try {
    // Mostrar indicador de carga
    const transactionsList = document.getElementById('transactionsList');
    if (transactionsList) {
      transactionsList.innerHTML = '<div class="loading">Cargando datos actualizados...</div>';
    }

    // Forzar recarga sin cach√©
    const timestamp = new Date().getTime();
    const response = await fetch(`/.netlify/functions/database?t=${timestamp}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${adminToken}`,
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      },
      cache: 'no-store'
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // Actualizar estad√≠sticas
      const total = data.transactions ? data.transactions.length : 0;
      const totalAmount = data.transactions ? 
        data.transactions.reduce((sum, t) => sum + (parseFloat(t.monto_total) || 0), 0) : 0;
      const totalFees = data.transactions ? 
        data.transactions.reduce((sum, t) => sum + (parseFloat(t.tarifa) || 0), 0) : 0;
      
      document.getElementById('totalTransactions').textContent = total;
      document.getElementById('totalAmount').textContent = `$${totalAmount.toFixed(2)}`;
      document.getElementById('totalFees').textContent = `$${totalFees.toFixed(2)}`;
      
      // Calcular promedio
      const avgAmount = total > 0 ? totalAmount / total : 0;
      document.getElementById('avgTransaction').textContent = `$${avgAmount.toFixed(2)}`;
      
      // Mostrar transacciones
      if (data.transactions && data.transactions.length > 0) {
        mostrarTransacciones(data.transactions);
      } else {
        transactionsList.innerHTML = '<div class="no-data">No hay transacciones recientes</div>';
      }
    } else {
      const errorData = await response.json().catch(() => ({}));
      console.error('Error en la respuesta:', response.status, errorData);
      if (transactionsList) {
        transactionsList.innerHTML = `<div class="error">Error al cargar datos: ${errorData.error || 'Error desconocido'}</div>`;
      }
    }
  } catch (error) {
    console.error('Error cargando datos:', error);
    const transactionsList = document.getElementById('transactionsList');
    if (transactionsList) {
      transactionsList.innerHTML = `<div class="error">Error de conexi√≥n: ${error.message}</div>`;
    }
  }
}

function mostrarTransacciones(transactions) {
  const transactionsList = document.getElementById('transactionsList');
  if (transactionsList && transactions.length > 0) {
    transactionsList.innerHTML = transactions.map(t => {
      const fecha = t.Fecha || t.fecha_transaccion || t.created_at;
      const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString() : 'N/A';
      const horaFormateada = fecha ? new Date(fecha).toLocaleTimeString() : 'N/A';
      
      return `
        <div class="transaction-item">
          <div class="transaction-header">
            <div class="transaction-id">Orden #${t['Orden ID'] || t.orden_id || t.ordenId || 'N/A'}</div>
            <div class="transaction-date">${fechaFormateada} ${horaFormateada}</div>
          </div>
          
          <div class="transaction-grid">
            <div class="transaction-field">
              <div class="field-label">Remitente</div>
              <div class="field-value">${t['Remitente Nombre'] || t.remitente_nombre || t.Remitente || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Tel√©fono</div>
              <div class="field-value">${t['Remitente Tel'] || t.remitente_telefono || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Email</div>
              <div class="field-value">${t['Remitente Email'] || t.remitente_email || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Beneficiario</div>
              <div class="field-value">${t['Benef Nombre'] || t.beneficiario_nombre || t.Beneficiario || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Ciudad</div>
              <div class="field-value">${t['Benef Ciudad'] || t.beneficiario_ciudad || t.Ciudad || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Moneda</div>
              <div class="field-value">${t.Entrega || t.moneda_entrega || t.Moneda || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Tarjeta Destino</div>
              <div class="field-value">${t['Tarjeta Numero'] || t.tarjeta_destinatario || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Monto USD</div>
              <div class="field-value">$${(t['Monto USD'] || t.monto_usd || 0).toFixed(2)}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">A Depositar</div>
              <div class="field-value">${t['Monto Tarjeta'] || t['Monto Depositar'] || t.monto_depositar || 0}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Tarifa</div>
              <div class="field-value">$${(t.Tarifa || t.tarifa || 0).toFixed(2)}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Estado PayPal</div>
              <div class="field-value">${t.paypal_status || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Notas</div>
              <div class="field-value">${t.Notas || t.notas || 'N/A'}</div>
            </div>
          </div>
          
          ${(t.documento_url || t['Documento URL'] || t.documentoUrl) ? 
            `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
              <a href="${t.documento_url || t['Documento URL'] || t.documentoUrl}" target="_blank" class="document-link">
                üìÑ Ver Documento de Identidad
              </a>
            </div>` : 
            '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); color: var(--muted); font-size: 14px;">Sin documento subido</div>'
          }
        </div>
      `;
    }).join('');
  }
}

// Cargar datos al iniciar y cada 30 segundos
cargarDatos();
setInterval(cargarDatos, 30000);
</script>

</body>
</html>
