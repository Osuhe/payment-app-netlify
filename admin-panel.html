<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Panel de AdministraciÃ³n - EnvÃ­os a Cuba</title>
<style>
  :root {
    --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    --card: rgba(15, 23, 42, 0.9);
    --border: #334155;
    --muted: #94a3b8;
    --ink: #f1f5f9;
    --accent: #3b82f6;
    --success: #10b981;
    --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }
  
  * { box-sizing: border-box; }
  
  html, body {
    margin: 0; padding: 0; width: 100%; min-height: 100vh;
    background: var(--bg);
    color: var(--ink);
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
  }
  
  .wrap {
    width: 100%; max-width: 1400px; margin: 0 auto; padding: 24px;
  }
  
  .card {
    background: var(--card);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
  }
  
  h1 {
    margin: 0 0 32px;
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-align: center;
  }
  
  h2 {
    margin: 0 0 24px;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--ink);
  }
  
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }
  
  .stat-card {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    border: 1px solid var(--border);
    padding: 24px;
    border-radius: 16px;
    text-align: center;
  }
  
  .stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }
  
  .stat-label {
    font-size: 14px;
    color: var(--muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .transaction-item {
    background: rgba(30, 41, 59, 0.5);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
  }
  
  .transaction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .transaction-id {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--accent);
  }
  
  .transaction-date {
    font-size: 0.875rem;
    color: var(--muted);
  }
  
  .transaction-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    font-size: 14px;
  }
  
  .transaction-field {
    display: flex;
    flex-direction: column;
  }
  
  .field-label {
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 4px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .field-value {
    color: var(--ink);
    font-weight: 500;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  
  .empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 12px;
    color: var(--ink);
  }
  
  .document-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    padding: 8px 16px;
    border: 1px solid var(--accent);
    border-radius: 8px;
  }
  
  .document-link:hover {
    background: var(--accent);
    color: white;
  }
  
  @media (max-width: 768px) {
    .wrap { padding: 16px; }
    .card { padding: 20px; }
    h1 { font-size: 2rem; }
    .transaction-grid { grid-template-columns: 1fr; }
    .stats { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h1>ðŸ’¼ Panel de AdministraciÃ³n</h1>
    
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="totalTransactions">0</div>
        <div class="stat-label">Total Transacciones</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalAmount">$0</div>
        <div class="stat-label">Monto Total Procesado</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalFees">$0</div>
        <div class="stat-label">Tarifas Cobradas</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgTransaction">$0</div>
        <div class="stat-label">Promedio por EnvÃ­o</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>ðŸ“‹ Transacciones Recientes</h2>
    <div id="transactionsList">
      <div class="empty-state">
        <h3>ðŸ’³ No hay transacciones</h3>
        <p>No se han registrado envÃ­os de dinero aÃºn.</p>
        <p>Las transacciones aparecerÃ¡n aquÃ­ automÃ¡ticamente cuando los usuarios completen un pago.</p>
      </div>
    </div>
  </div>

  <div class="card" id="documentsSection" style="display: none;">
    <h2>ðŸ“„ Documentos de Identidad</h2>
    <div id="documentsList">
      <div class="empty-state">
        <h3>ðŸ“„ No hay documentos</h3>
        <p>Los documentos de identidad aparecerÃ¡n aquÃ­ cuando los usuarios los suban.</p>
      </div>
    </div>
  </div>
</div>

<script>
// Verificar autenticaciÃ³n al cargar la pÃ¡gina
let adminToken = null;

function verificarAutenticacion() {
  adminToken = localStorage.getItem('adminToken');
  
  if (!adminToken) {
    const token = prompt('ðŸ” Acceso restringido\n\nIngresa el token de administrador:');
    if (!token || token !== 'admin-secure-token-2024') {
      alert('âŒ Token incorrecto. Acceso denegado.');
      window.location.href = '/';
      return false;
    }
    localStorage.setItem('adminToken', token);
    adminToken = token;
  }
  return true;
}

// Verificar autenticaciÃ³n al cargar
if (!verificarAutenticacion()) {
  throw new Error('Acceso no autorizado');
}

// Cargar datos automÃ¡ticamente
async function cargarDatos() {
  try {
    const response = await fetch('/.netlify/functions/database', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${adminToken}`
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // Actualizar estadÃ­sticas
      document.getElementById('totalTransactions').textContent = data.total || 0;
      document.getElementById('totalAmount').textContent = `$${(data.totalAmount || 0).toFixed(2)}`;
      document.getElementById('totalFees').textContent = `$${(data.totalFees || 0).toFixed(2)}`;
      
      // Calcular promedio
      const avgAmount = data.total > 0 ? (data.totalAmount || 0) / data.total : 0;
      document.getElementById('avgTransaction').textContent = `$${avgAmount.toFixed(2)}`;
      
      // Mostrar transacciones
      if (data.transactions && data.transactions.length > 0) {
        mostrarTransacciones(data.transactions);
      }
    }
  } catch (error) {
    console.error('Error cargando datos:', error);
  }
}

function mostrarTransacciones(transactions) {
  const transactionsList = document.getElementById('transactionsList');
  if (transactionsList && transactions.length > 0) {
    transactionsList.innerHTML = transactions.map(t => {
      const fecha = t.Fecha || t.fecha_transaccion || t.created_at;
      const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString() : 'N/A';
      const horaFormateada = fecha ? new Date(fecha).toLocaleTimeString() : 'N/A';
      
      return `
        <div class="transaction-item">
          <div class="transaction-header">
            <div class="transaction-id">Orden #${t['Orden ID'] || t.orden_id || t.ordenId || 'N/A'}</div>
            <div class="transaction-date">${fechaFormateada} ${horaFormateada}</div>
          </div>
          
          <div class="transaction-grid">
            <div class="transaction-field">
              <div class="field-label">Remitente</div>
              <div class="field-value">${t['Remitente Nombre'] || t.remitente_nombre || t.Remitente || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">TelÃ©fono</div>
              <div class="field-value">${t['Remitente Tel'] || t.remitente_telefono || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Email</div>
              <div class="field-value">${t['Remitente Email'] || t.remitente_email || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Beneficiario</div>
              <div class="field-value">${t['Benef Nombre'] || t.beneficiario_nombre || t.Beneficiario || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Ciudad</div>
              <div class="field-value">${t['Benef Ciudad'] || t.beneficiario_ciudad || t.Ciudad || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Moneda</div>
              <div class="field-value">${t.Entrega || t.moneda_entrega || t.Moneda || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Tarjeta Destino</div>
              <div class="field-value">${t['Tarjeta Numero'] || t.tarjeta_destinatario || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Monto USD</div>
              <div class="field-value">$${(t['Monto USD'] || t.monto_usd || 0).toFixed(2)}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">A Depositar</div>
              <div class="field-value">${t['Monto Tarjeta'] || t['Monto Depositar'] || t.monto_depositar || 0}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Tarifa</div>
              <div class="field-value">$${(t.Tarifa || t.tarifa || 0).toFixed(2)}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Estado PayPal</div>
              <div class="field-value">${t.paypal_status || 'N/A'}</div>
            </div>
            
            <div class="transaction-field">
              <div class="field-label">Notas</div>
              <div class="field-value">${t.Notas || t.notas || 'N/A'}</div>
            </div>
          </div>
          
          ${(t.documento_url || t['Documento URL'] || t.documentoUrl) ? 
            `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
              <a href="${t.documento_url || t['Documento URL'] || t.documentoUrl}" target="_blank" class="document-link">
                ðŸ“„ Ver Documento de Identidad
              </a>
            </div>` : 
            '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); color: var(--muted); font-size: 14px;">Sin documento subido</div>'
          }
        </div>
      `;
    }).join('');
  }
}

// Cargar datos al iniciar y cada 30 segundos
cargarDatos();
setInterval(cargarDatos, 30000);
</script>

</body>
</html>
